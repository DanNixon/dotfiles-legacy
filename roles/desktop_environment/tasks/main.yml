---
- name: Ensure desktop environment pakages are installed
  become: yes
  package:
    name:
      - adobe-source-han-sans-otc-fonts
      - alacritty
      - blueman
      - feh
      - grim
      - libnotify
      - light
      - mako
      - sway
      - swaylock
      - ttf-dejavu
      - waybar
      - wl-clipboard
      - xdg-utils
      - xorg-xwayland
      - zathura
      - zathura-pdf-mupdf
    state: present

- name: Ensure directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: "u=rwx,g=,o="
  loop:
    - "{{ desktop_environment_applications_dir }}"
    - "{{ desktop_environment_script_dir }}"
    - "{{ desktop_environment_config_dir }}/alacritty"
    - "{{ desktop_environment_config_dir }}/mako"
    - "{{ desktop_environment_config_dir }}/sway"
    - "{{ desktop_environment_config_dir }}/waybar"

- name: Ensure configuration is present
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "u=r,g=,o="
  loop:
    - src: chromium-flags.conf
      dest: "{{ ansible_user_dir }}/.config/chromium-flags.conf"
    - src: mako.conf
      dest: "{{ desktop_environment_config_dir }}/mako/config"
    - src: waybar.css
      dest: "{{ desktop_environment_config_dir }}/waybar/style.css"
    - src: zathura.desktop
      dest: "{{ desktop_environment_applications_dir }}/zathura.desktop"

- name: Ensure configuration is present
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "u=r,g=,o="
  loop:
    - src: alacritty.yml.j2
      dest: "{{ desktop_environment_config_dir }}/alacritty/alacritty.yml"
    - src: sway.j2
      dest: "{{ desktop_environment_config_dir }}/sway/config"
    - src: waybar.json.j2
      dest: "{{ desktop_environment_config_dir }}/waybar/config"
  tags:
    - desktop_environment_quick

- name: Update applications database
  command: update-desktop-database "{{ desktop_environment_applications_dir }}"

- name: Ensure scripts are present
  copy:
    src: scripts/
    dest: "{{ desktop_environment_script_dir }}"
    mode: "u=rx,g=,o="

- name: Ensure default applications are set
  command: xdg-mime default "{{ item.app }}" "{{ item.type }}"
  loop:
    - app: feh.desktop
      type: image/jpeg
    - app: feh.desktop
      type: image/png
    - app: feh.desktop
      type: image/webp
    - app: zathura.desktop
      type: application/pdf

- name: Reload Sway
  command: swaymsg reload
  tags:
    - never
    - desktop_environment_quick
